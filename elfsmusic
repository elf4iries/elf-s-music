--[[
    YouTube Music Player - Versão Corrigida e Testada
    Baseado no Basalt 1.6.5 para CC:Tweaked
]]

-- Verificação segura do Basalt
local basalt
if not fs.exists("/basalt") then
    print("Basalt não encontrado. Instalando...")
    shell.run("wget", "run", "https://raw.githubusercontent.com/Pyroxenium/Basalt/main/install.lua")
end

local success, err = pcall(function()
    basalt = require("basalt")
end)

if not success then
    print("Erro ao carregar Basalt: " .. err)
    return
end

-- Criar a janela principal
local main = basalt.createFrame()
main:setBackground(colors.lightBlue)

-- Cores do tema
local TEXT_COLOR = colors.white
local BUTTON_COLOR = colors.blue
local BACKGROUND_COLOR = colors.lightBlue

-- Título
local title = main:addLabel()
title:setText("YOUTUBE MUSIC PLAYER")
title:setPosition(2, 2)
title:setForeground(TEXT_COLOR)

local subtitle = main:addLabel()
subtitle:setText("music.madefor.cc")
subtitle:setPosition(2, 3)
subtitle:setForeground(colors.gray)

-- Linha separadora
local line = main:addLabel()
line:setText(string.rep("─", 48))
line:setPosition(1, 4)
line:setForeground(colors.blue)

-- Campo de URL
local urlLabel = main:addLabel()
urlLabel:setText("Cole o link do YouTube:")
urlLabel:setPosition(2, 6)
urlLabel:setForeground(TEXT_COLOR)

local urlInput = main:addInput()
urlInput:setPosition(2, 7)
urlInput:setSize(45, 1)
urlInput:setBackground(colors.white)
urlInput:setForeground(colors.black)

-- Controles
local playBtn = main:addButton()
playBtn:setText("TOCAR")
playBtn:setPosition(2, 9)
playBtn:setSize(10, 3)
playBtn:setBackground(BUTTON_COLOR)
playBtn:setForeground(TEXT_COLOR)

local stopBtn = main:addButton()
stopBtn:setText("PARAR")
stopBtn:setPosition(14, 9)
stopBtn:setSize(10, 3)
stopBtn:setBackground(colors.red)
stopBtn:setForeground(TEXT_COLOR)

-- Status
local statusLabel = main:addLabel()
statusLabel:setText("Status:")
statusLabel:setPosition(2, 13)
statusLabel:setForeground(TEXT_COLOR)

local status = main:addLabel()
status:setText("Pronto")
status:setPosition(9, 13)
status:setForeground(colors.lime)

-- Informações
local infoLabel = main:addLabel()
infoLabel:setText("Info:")
infoLabel:setPosition(2, 14)
infoLabel:setForeground(TEXT_COLOR)

local info = main:addLabel()
info:setText("Aguardando URL...")
info:setPosition(8, 14)
info:setForeground(colors.yellow)

-- Área de log
local logLabel = main:addLabel()
logLabel:setText("Log:")
logLabel:setPosition(2, 16)
logLabel:setForeground(TEXT_COLOR)

log:setPosition(2, 17)
log:setSize(45, 5)
log:setBackground(colors.black)
log:setForeground(colors.white)
log:setValue("Bem-vindo ao YouTube Music Player!\n")

-- Instalar o programa music se necessário
local function installMusic()
    if not fs.exists("music") then
        log:addText("Instalando music player...\n")
        local success = shell.run("wget", "https://music.madefor.cc/music.lua", "music")
        if success then
            log:addText("Music player instalado com sucesso!\n")
            return true
        else
            log:addText("Erro na instalação do music player\n")
            return false
        end
    end
    return true
end

-- Verificar instalação na inicialização
if not installMusic() then
    status:setText("Erro instalação")
    status:setForeground(colors.red)
end

-- Variáveis de estado
local isPlaying = false

-- Função para validar URL do YouTube
local function isValidYouTubeURL(url)
    if not url or url == "" then
        return false, "URL vazia"
    end
    
    -- Padrões de URLs do YouTube
    if url:find("youtube.com/watch") or url:find("youtu.be/") then
        return true
    end
    
    return false, "URL do YouTube inválida"
end

-- Função para tocar música
local function playMusic(url)
    local valid, errorMsg = isValidYouTubeURL(url)
    if not valid then
        status:setText("URL inválida")
        status:setForeground(colors.red)
        info:setText(errorMsg)
        log:addText("Erro: " .. errorMsg .. "\n")
        return false
    end
    
    if isPlaying then
        status:setText("Já tocando")
        info:setText("Aguarde a reprodução atual terminar")
        return false
    end
    
    status:setText("Convertendo...")
    status:setForeground(colors.yellow)
    info:setText("Processando: " .. url:sub(1, 30) .. "...")
    log:addText("Iniciando conversão: " .. url .. "\n")
    
    isPlaying = true
    
    -- Executar em thread separada para não travar a interface
    parallel.waitForAny(
        function()
            local success, result = pcall(function()
                return shell.run("music", "play", url)
            end)
            
            isPlaying = false
            
            if success and result then
                status:setText("Concluído")
                status:setForeground(colors.lime)
                info:setText("Reprodução finalizada")
                log:addText("Reprodução concluída com sucesso\n")
            else
                status:setText("Erro")
                status:setForeground(colors.red)
                info:setText("Falha na reprodução")
                log:addText("Erro na reprodução\n")
            end
        end,
        function()
            -- Thread de monitoramento para permitir parada
            while isPlaying do
                local event = os.pullEvent()
                if event == "stop_playback" then
                    break
                end
            end
        end
    )
    
    return true
end

-- Função para parar reprodução
local function stopMusic()
    if isPlaying then
        isPlaying = false
        os.queueEvent("stop_playback")
        
        local success = pcall(function()
            shell.run("music", "stop")
        end)
        
        status:setText("Parado")
        status:setForeground(colors.orange)
        info:setText("Reprodução interrompida")
        log:addText("Reprodução parada pelo usuário\n")
        
        return success
    else
        status:setText("Não tocando")
        info:setText("Nenhuma reprodução em andamento")
        return false
    end
end

-- Event handlers
playBtn:onClick(function()
    local url = urlInput:getValue()
    playMusic(url)
end)

stopBtn:onClick(function()
    stopMusic()
end)

-- Exemplos
local examplesLabel = main:addLabel()
examplesLabel:setText("Exemplos:")
examplesLabel:setPosition(2, 23)
examplesLabel:setForeground(TEXT_COLOR)

local example1 = main:addLabel()
example1:setText("youtube.com/watch?v=dQw4w9WgXcQ")
example1:setPosition(2, 24)
example1:setForeground(colors.gray)

local example2 = main:addLabel()
example2:setText("youtu.be/dQw4w9WgXcQ")
example2:setPosition(2, 25)
example2:setForeground(colors.gray)

-- Footer
local footer = main:addLabel()
footer:setText("Pressione Ctrl+T para sair")
footer:setPosition(2, 27)
footer:setForeground(colors.gray)

-- Foco no input
urlInput:setFocus()

-- Iniciar a interface
basalt.run()
