--[[
    YouTube Music Player - Versão Estável
    CC:Tweaked + Basalt
]]

-- Carregar Basalt
local ok, err = pcall(function()
    basalt = require("basalt")
end)
if not ok then
    print("Erro ao carregar Basalt: " .. err)
    return
end

-- Criar a janela principal
local main = basalt.createFrame()
main:setBackground(colors.lightBlue)

-- Cores do tema
local TEXT_COLOR = colors.white
local BUTTON_COLOR = colors.blue

-- Título
local title = main:addLabel()
title:setText("YOUTUBE MUSIC PLAYER")
title:setPosition(2, 2)
title:setForeground(TEXT_COLOR)

local subtitle = main:addLabel()
subtitle:setText("music.madefor.cc")
subtitle:setPosition(2, 3)
subtitle:setForeground(colors.gray)

-- Linha separadora
local line = ""
for i = 1, 48 do line = line .. "─" end
local sep = main:addLabel()
sep:setText(line)
sep:setPosition(1, 4)
sep:setForeground(colors.blue)

-- Campo de URL
local urlLabel = main:addLabel()
urlLabel:setText("YouTube URL:")
urlLabel:setPosition(2, 6)
urlLabel:setForeground(TEXT_COLOR)

local urlInput = main:addInput()
urlInput:setPosition(2, 7)
urlInput:setSize(45, 1)
urlInput:setBackground(colors.white)
urlInput:setForeground(colors.black)

-- Controles
local playBtn = main:addButton()
playBtn:setText("TOCAR")
playBtn:setPosition(2, 9)
playBtn:setSize(10, 3)
playBtn:setBackground(BUTTON_COLOR)
playBtn:setForeground(TEXT_COLOR)

local stopBtn = main:addButton()
stopBtn:setText("PARAR")
stopBtn:setPosition(14, 9)
stopBtn:setSize(10, 3)
stopBtn:setBackground(colors.red)
stopBtn:setForeground(TEXT_COLOR)

-- Status
local statusLabel = main:addLabel()
statusLabel:setText("Status:")
statusLabel:setPosition(2, 13)
statusLabel:setForeground(TEXT_COLOR)

local status = main:addLabel()
status:setText("Pronto")
status:setPosition(9, 13)
status:setForeground(colors.lime)

-- Informações
local infoLabel = main:addLabel()
infoLabel:setText("Info:")
infoLabel:setPosition(2, 14)
infoLabel:setForeground(TEXT_COLOR)

local info = main:addLabel()
info:setText("Aguardando URL...")
info:setPosition(8, 14)
info:setForeground(colors.yellow)

-- Área de log (usando List em vez de Textfield)
local logLabel = main:addLabel()
logLabel:setText("Log:")
logLabel:setPosition(2, 16)
logLabel:setForeground(TEXT_COLOR)

local logList = main:addList()
logList:setPosition(2, 17)
logList:setSize(45, 5)
logList:setBackground(colors.black)
logList:setForeground(colors.white)

-- Instalar o programa music se necessário
local function installMusic()
    if not fs.exists("music") then
        addLog("Instalando music player...")
        local success = shell.run("wget", "https://music.madefor.cc/music.lua", "music")
        if success then
            addLog("Music player instalado!")
            return true
        else
            addLog("Erro na instalação")
            return false
        end
    end
    return true
end

-- Verificar instalação
addLog("Iniciando player...")
if not installMusic() then
    status:setText("Erro instalação")
    status:setForeground(colors.red)
end

-- Variáveis de estado
local isPlaying = false

-- Função para validar URL do YouTube
local function isValidYouTubeURL(url)
    if not url or url == "" then
        return false, "URL vazia"
    end
    
    if url:find("youtube.com/watch") or url:find("youtu.be/") then
        return true
    end
    
    return false, "URL do YouTube inválida"
end

-- Função para tocar música
local function playMusic(url)
    local valid, errorMsg = isValidYouTubeURL(url)
    if not valid then
        status:setText("URL inválida")
        status:setForeground(colors.red)
        info:setText(errorMsg)
        addLog("Erro: " .. errorMsg)
        return false
    end
    
    if isPlaying then
        status:setText("Já tocando")
        info:setText("Aguarde...")
        return false
    end
    
    status:setText("Convertendo...")
    status:setForeground(colors.yellow)
    info:setText("Processando...")
    addLog("Iniciando: " .. url:sub(1, 30))
    
    isPlaying = true
    
    -- Executar em thread separada
    parallel.waitForAny(
        function()
            local success, result = pcall(function()
                return shell.run("music", "play", url)
            end)
            
            isPlaying = false
            
            if success and result then
                status:setText("Concluído")
                status:setForeground(colors.lime)
                info:setText("Reprodução finalizada")
                addLog("Reprodução concluída")
            else
                status:setText("Erro")
                status:setForeground(colors.red)
                info:setText("Falha na reprodução")
                addLog("Erro na reprodução")
            end
        end,
        function()
            while isPlaying do
                local event = os.pullEvent()
                if event == "stop_playback" then
                    break
                end
            end
        end
    )
    
    return true
end

-- Função para parar
local function stopMusic()
    if isPlaying then
        isPlaying = false
        os.queueEvent("stop_playback")
        
        pcall(function()
            shell.run("music", "stop")
        end)
        
        status:setText("Parado")
        status:setForeground(colors.orange)
        info:setText("Reprodução interrompida")
        addLog("Parado pelo usuário")
    else
        status:setText("Não tocando")
        info:setText("Nenhuma reprodução")
    end
end

-- Event handlers
playBtn:onClick(function()
    local url = urlInput:getValue()
    playMusic(url)
end)

stopBtn:onClick(function()
    stopMusic()
end)

-- Exemplos
local examplesLabel = main:addLabel()
examplesLabel:setText("Exemplos:")
examplesLabel:setPosition(2, 23)
examplesLabel:setForeground(TEXT_COLOR)

local example1 = main:addLabel()
example1:setText("youtube.com/watch?v=dQw4w9WgXcQ")
example1:setPosition(2, 24)
example1:setForeground(colors.gray)

local example2 = main:addLabel()
example2:setText("youtu.be/dQw4w9WgXcQ")
example2:setPosition(2, 25)
example2:setForeground(colors.gray)

-- Footer
local footer = main:addLabel()
footer:setText("Ctrl+T para sair")
footer:setPosition(2, 27)
footer:setForeground(colors.gray)

-- Foco no input
urlInput:setFocus()

-- Mensagem inicial
addLog("Sistema pronto!")
addLog("Cole uma URL do YouTube")

-- Iniciar interface
basalt.run()
