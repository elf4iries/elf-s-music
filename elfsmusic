--[[
    YouTube Music Player - Conversor madefor.cc
    Converte e toca URLs do YouTube automaticamente
]]

local basalt = require("basalt")

local main = basalt.createFrame()
main:setBackground(colors.lightBlue)

-- Cores do tema
local TEXT_COLOR = colors.white
local BUTTON_COLOR = colors.blue
local BACKGROUND_COLOR = colors.lightBlue

-- Título
local title = main:addLabel()
title:setText("YOUTUBE CONVERTER")
title:setPosition(2, 2)
title:setForeground(TEXT_COLOR)

local subtitle = main:addLabel()
subtitle:setText("Converte e toca automaticamente")
subtitle:setPosition(2, 3)
subtitle:setForeground(colors.gray)

-- Campo de URL
local urlLabel = main:addLabel()
urlLabel:setText("Cole o link do YouTube:")
urlLabel:setPosition(2, 5)
urlLabel:setForeground(TEXT_COLOR)

local urlInput = main:addInput()
urlInput:setPosition(2, 6)
urlInput:setSize(45, 1)
urlInput:setBackground(colors.white)
urlInput:setForeground(colors.black)

-- Barra de progresso da conversão
local progressLabel = main:addLabel()
progressLabel:setText("Progresso:")
progressLabel:setPosition(2, 8)
progressLabel:setForeground(TEXT_COLOR)

local progressBar = main:addProgressbar()
progressBar:setPosition(2, 9)
progressBar:setSize(45, 1)
progressBar:setProgress(0)
progressBar:setBackground(colors.gray)
progressBar:setForeground(colors.green)

-- Controles
local playBtn = main:addButton()
playBtn:setText("CONVERTER & TOCAR")
playBtn:setPosition(2, 11)
playBtn:setSize(18, 3)
playBtn:setBackground(BUTTON_COLOR)
playBtn:setForeground(TEXT_COLOR)

local stopBtn = main:addButton()
stopBtn:setText("PARAR")
stopBtn:setPosition(22, 11)
stopBtn:setSize(8, 3)
stopBtn:setBackground(colors.red)
stopBtn:setForeground(TEXT_COLOR)

-- Status
local statusLabel = main:addLabel()
statusLabel:setText("Status:")
statusLabel:setPosition(2, 15)
statusLabel:setForeground(TEXT_COLOR)

local status = main:addLabel()
status:setText("Pronto para converter")
status:setPosition(9, 15)
status:setForeground(colors.lime)

-- Informações do áudio
local infoLabel = main:addLabel()
infoLabel:setText("Informações:")
infoLabel:setPosition(2, 17)
infoLabel:setForeground(TEXT_COLOR)

local audioInfo = main:addLabel()
audioInfo:setText("Nenhum áudio carregado")
audioInfo:setPosition(2, 18)
audioInfo:setForeground(colors.yellow)

-- Verificar/instalar o music
local function installMusic()
    if not fs.exists("music") then
        status:setText("Instalando conversor...")
        progressBar:setProgress(25)
        
        local success = shell.run("wget", "https://music.madefor.cc/music.lua", "music")
        
        if success then
            progressBar:setProgress(100)
            status:setText("Conversor instalado!")
            sleep(1)
            progressBar:setProgress(0)
            return true
        else
            status:setText("Erro na instalação")
            return false
        end
    end
    return true
end

-- Variáveis de estado
local isPlaying = false
local isConverting = false

-- Função para simular progresso de conversão
local function simulateConversion()
    for i = 1, 100, 5 do
        if not isConverting then break end
        progressBar:setProgress(i)
        status:setText("Convertendo... " .. i .. "%")
        sleep(0.1)
    end
end

-- Função principal para converter e tocar
local function convertAndPlay(url)
    if not url or url == "" then
        status:setText("Cole um link do YouTube")
        return false
    end
    
    if isPlaying then
        status:setText("Já está tocando")
        return false
    end
    
    -- Verificar se é um link do YouTube válido
    if not (url:find("youtube.com") or url:find("youtu.be")) then
        status:setText("Link do YouTube inválido")
        return false
    end
    
    if not installMusic() then
        return false
    end
    
    status:setText("Iniciando conversão...")
    isConverting = true
    isPlaying = true
    
    -- Simular progresso de conversão
    parallel.waitForAny(
        function()
            simulateConversion()
        end,
        function()
            -- Converter e tocar
            local success = shell.run("music", "play", url)
            
            isConverting = false
            isPlaying = false
            progressBar:setProgress(0)
            
            if success then
                status:setText("Conversão completa!")
                audioInfo:setText("Reprodução finalizada")
            else
                status:setText("Erro na conversão/reprodução")
                audioInfo:setText("Verifique o link e conexão")
            end
        end
    )
    
    return true
end

-- Função para parar
local function stopPlayback()
    if isPlaying then
        isConverting = false
        isPlaying = false
        shell.run("music", "stop")
        progressBar:setProgress(0)
        status:setText("Reprodução interrompida")
        audioInfo:setText("Reprodução parada pelo usuário")
    else
        status:setText("Nada tocando no momento")
    end
end

-- Event handlers
playBtn:onClick(function()
    local url = urlInput:getValue()
    audioInfo:setText("Processando: " .. url:sub(1, 30) .. "...")
    convertAndPlay(url)
end)

stopBtn:onClick(function()
    stopPlayback()
end)

-- Exemplos de links
local examplesLabel = main:addLabel()
examplesLabel:setText("Exemplos de links:")
examplesLabel:setPosition(2, 20)
examplesLabel:setForeground(TEXT_COLOR)

local example1 = main:addLabel()
example1:setText("youtube.com/watch?v=...")
example1:setPosition(2, 21)
example1:setForeground(colors.gray)

local example2 = main:addLabel()
example2:setText("youtu.be/...")
example2:setPosition(2, 22)
example2:setForeground(colors.gray)

-- Dica
local tip = main:addLabel()
tip:setText("Dica: O conversor baixa e toca automaticamente")
tip:setPosition(2, 24)
tip:setForeground(colors.cyan)

-- Iniciar interface
basalt.run()
