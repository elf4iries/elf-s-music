--[[
    YouTube Music Player (Basalt UI)
    Autor: elf4iries
    Versão: Com player de música integrado
]]

-- Função para verificar se o Basalt está instalado corretamente
local function isBasaltInstalled()
    if fs.exists("/basalt") then
        return true
    end
    if fs.exists("/basalt.lua") then
        return true
    end
    if fs.exists("/rom/modules/main/basalt.lua") then
        return true
    end
    
    local success, _ = pcall(require, "basalt")
    return success
end

-- Instalar Basalt automaticamente se não estiver instalado
if not isBasaltInstalled() then
    print("================================")
    print(" Instalando Basalt...")
    print("================================")
    
    print("Tentando metodo 1: Pyroxenium/Basalt2...")
    local success1 = shell.run("wget", "run", "https://raw.githubusercontent.com/Pyroxenium/Basalt2/main/install.lua")
    
    if not success1 or not isBasaltInstalled() then
        print("Metodo 1 falhou. Tentando metodo 2: madefor.cc...")
        local success2 = shell.run("wget", "run", "https://basalt.madefor.cc/install.lua")
        
        if not success2 or not isBasaltInstalled() then
            print("Metodo 2 falhou. Tentando metodo 3: Download direto...")
            local response = http.get("https://raw.githubusercontent.com/Pyroxenium/Basalt2/main/basalt.lua")
            if response then
                local basaltCode = response.readAll()
                response.close()
                local file = fs.open("basalt.lua", "w")
                file.write(basaltCode)
                file.close()
                print("Download direto concluido!")
            else
                print("ERRO NA INSTALACAO")
                print("Tente instalar manualmente:")
                print("wget run https://basalt.madefor.cc/install.lua")
                return
            end
        end
    end
    
    print("Basalt instalado com sucesso!")
end

-- Carregar Basalt com segurança
local basalt
local success, err = pcall(function()
    basalt = require("basalt")
end)

if not success then
    print("Erro ao carregar Basalt: " .. tostring(err))
    return
end

-- Cria a janela principal
local main = basalt.createFrame()
main:setBackground(colors.black)

-- Banner simplificado
local banner = {
    "   ELF4IRIES",
    "  YOUTUBE MUSIC"
}

for i, line in ipairs(banner) do
    local label = main:addLabel()
    label:setText(line)
    label:setPosition(2, i)
    label:setForeground(colors.lightBlue)
end

-- Campo para URL do YouTube
local urlLabel = main:addLabel()
urlLabel:setText("URL do YouTube:")
urlLabel:setPosition(2, 4)
urlLabel:setForeground(colors.cyan)

local urlInput = main:addInput()
urlInput:setPosition(2, 5)
urlInput:setSize(40, 1)
urlInput:setBackground(colors.blue)
urlInput:setForeground(colors.white)
urlInput:setInputType("text")

-- Botão para tocar URL
local playBtn = main:addButton()
playBtn:setText("TOCAR")
playBtn:setPosition(2, 7)
playBtn:setSize(8, 3)
playBtn:setBackground(colors.green)
playBtn:setForeground(colors.black)

-- Botão para parar
local stopBtn = main:addButton()
stopBtn:setText("PARAR")
stopBtn:setPosition(12, 7)
stopBtn:setSize(8, 3)
stopBtn:setBackground(colors.red)
stopBtn:setForeground(colors.black)

-- Status do player
local status = main:addLabel()
status:setText("Pronto para tocar")
status:setPosition(2, 11)
status:setForeground(colors.lime)

-- Controles de volume
local volLabel = main:addLabel()
volLabel:setText("Volume:")
volLabel:setPosition(2, 13)
volLabel:setForeground(colors.cyan)

local volUpBtn = main:addButton()
volUpBtn:setText("+")
volUpBtn:setPosition(10, 13)
volUpBtn:setSize(4, 2)
volUpBtn:setBackground(colors.lightBlue)

local volDownBtn = main:addButton()
volDownBtn:setText("-")
volDownBtn:setPosition(15, 13)
volDownBtn:setSize(4, 2)
volDownBtn:setBackground(colors.lightBlue)

-- Lista de músicas salvas (opcional)
local savedLabel = main:addLabel()
savedLabel:setText("URLs salvas:")
savedLabel:setPosition(2, 16)
savedLabel:setForeground(colors.cyan)

local savedList = main:addList()
savedList:setPosition(2, 17)
savedList:setSize(40, 6)
savedList:setBackground(colors.blue)
savedList:setForeground(colors.white)

-- Adicionar algumas URLs de exemplo
savedList:addItem("https://www.youtube.com/watch?v=dQw4w9WgXcQ")
savedList:addItem("https://youtu.be/dQw4w9WgXcQ")

-- Variáveis do player
local currentProcess = nil
local volume = 100

-- Função para tocar música
local function playMusic(url)
    if currentProcess then
        -- Se já está tocando algo, para primeiro
        os.queueEvent("terminate")
        currentProcess = nil
        sleep(0.5)
    end
    
    status:setText("Iniciando player...")
    
    -- Verifica se é uma URL válida do YouTube
    if not url:find("youtu") then
        status:setText("Erro: URL do YouTube invalida")
        return false
    end
    
    -- Tenta usar diferentes métodos para tocar
    local commands = {
        "yt dl " .. url,
        "music play " .. url,
        "ccyt play " .. url
    }
    
    for _, cmd in ipairs(commands) do
        status:setText("Tentando: " .. cmd)
        local success = shell.run(cmd)
        if success then
            currentProcess = true
            status:setText("Tocando: " .. url:sub(1, 30) .. "...")
            return true
        end
        sleep(1)
    end
    
    -- Se nenhum player funcionar, tenta baixar um
    status:setText("Instalando player...")
    local installSuccess = shell.run("wget", "run", "https://pastebin.com/raw/example") -- Substitua por URL real
    
    if installSuccess then
        status:setText("Player instalado, tentando novamente...")
        sleep(2)
        return playMusic(url)
    end
    
    status:setText("Erro: Nenhum player disponivel")
    return false
end

-- Função para parar música
local function stopMusic()
    if currentProcess then
        os.queueEvent("terminate")
        currentProcess = nil
        status:setText("Musica parada")
    else
        status:setText("Nenhuma musica tocando")
    end
end

-- Função para ajustar volume
local function setVolume(newVol)
    volume = math.max(0, math.min(100, newVol))
    -- Aqui você implementaria o controle de volume real
    -- dependendo do player que estiver usando
    status:setText("Volume: " .. volume .. "%")
end

-- Eventos dos botões
playBtn:onClick(function()
    local url = urlInput:getValue()
    if url and url ~= "" then
        playMusic(url)
    else
        status:setText("Digite uma URL do YouTube")
    end
end)

stopBtn:onClick(function()
    stopMusic()
end)

volUpBtn:onClick(function()
    setVolume(volume + 10)
end)

volDownBtn:onClick(function()
    setVolume(volume - 10)
end)

-- Quando seleciona uma URL salva
savedList:onSelect(function(self)
    local idx = self:getItemIndex()
    local items = {
        "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
        "https://youtu.be/dQw4w9WgXcQ"
    }
    
    if items[idx] then
        urlInput:setValue(items[idx])
        status:setText("URL carregada: " .. items[idx]:sub(1, 30) .. "...")
    end
end)

-- Instruções
local helpLabel = main:addLabel()
helpLabel:setText("Cole URL do YouTube acima e clique em TOCAR")
helpLabel:setPosition(2, 24)
helpLabel:setForeground(colors.gray)

-- Inicia a interface
basalt.run()
